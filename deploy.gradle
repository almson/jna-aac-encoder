plugins {
    id 'java'
}

apply from: 'common.gradle'

def libSource = project.properties['libSource']
if (libSource == null) {
    throw new GradleException("'libSource' system property must be set")
}

task win64(type: Jar) {
    def target = 'win64'
    doFirst { buildLibrary(libSource, target) }
    archiveName = "${archivesBaseName}-${version}-${target}.jar"
    from sourceSets.main.output
    from("${libSource}/.libs") {
        include '*.dll'
    }
    rename '.+(fdk-aac).+(\\.dll)', '$1$2'
}

task linux64(type: Jar) {
    def target = 'linux64'
    doFirst { buildLibrary(libSource, target) }
    archiveName = "${archivesBaseName}-${version}-${target}.jar"
    from sourceSets.main.output
    from("${libSource}/.libs") {
        include '*.so'
    }
}

void buildLibrary(source, target) {
    exec {
        workingDir projectDir
        commandLine "scripts/build_library.sh", "-s", source, "-t", target
    }
}